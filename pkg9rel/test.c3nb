{"cells":[{"kind":2,"languageId":"javascript","value":"c3.ReliabilityMockData.createMasterSensorsForE2E('MasterSensors.csv', '1__Redwood City')\n","output":[{"items":[{"mime":"text/plain","value":["\u001b[31m---------------------------------------------------------------------------\u001b[0m","Internal Java error: ReferenceError: \"c3\" is not defined. (eval code#1(eval)#1)!"]}]}],"executionSummary":{"timing":{"startTime":1768517629120,"endTime":1768517629439},"executionOrder":2,"success":false}},{"kind":1,"languageId":"markdown","value":"# Unit & Integration Testing\n\n## Coding Requirements\n\n* React component tests\n* API mocking\n* Facility selection scenarios\n* Error state tests\n\n## UI Requirements\n\n* Visual validation","output":[],"executionSummary":{}},{"kind":1,"languageId":"markdown","value":"```javascript\n// 1. React Component Tests: DropdownContainer\n// Uses: @testing-library/react, jest\n/*\n  This test validates:\n  - Component rendering state (closed vs open)\n  - Interaction verification (click events)\n  - Props handling (selection callbacks)\n*/\n\n// Mock Setup\nconst mockSections = [\n    { id: '1', items: [{ id: 'opt1', label: 'Option 1', value: 'opt1' }] }\n];\n\ndescribe('DropdownContainer Component', () => {\n    test('renders children trigger', () => {\n        const { getByText } = render(<DropdownContainer>Trigger</DropdownContainer>);\n        expect(getByText('Trigger')).toBeTruthy();\n    });\n\n    test('does not render menu when closed', () => {\n        const { queryByText } = render(\n            <DropdownContainer isOpen={false} sections={mockSections}>Trigger</DropdownContainer>\n        );\n        expect(queryByText('Option 1')).toBeNull();\n    });\n\n    test('renders menu items when open', () => {\n        const { getByText } = render(\n            <DropdownContainer isOpen={true} sections={mockSections}>Trigger</DropdownContainer>\n        );\n        expect(getByText('Option 1')).toBeTruthy();\n    });\n\n    test('triggers onSelect and closes on item click', () => {\n        const onSelect = jest.fn();\n        const onOpenChange = jest.fn();\n        const { getByText } = render(\n            <DropdownContainer \n                isOpen={true} \n                sections={mockSections} \n                onSelect={onSelect} \n                onOpenChange={onOpenChange}\n            >Trigger</DropdownContainer>\n        );\n\n        fireEvent.click(getByText('Option 1'));\n        expect(onSelect).toHaveBeenCalledWith('opt1', 'opt1');\n        expect(onOpenChange).toHaveBeenCalledWith(false);\n    });\n});\n```","output":[],"executionSummary":{}},{"kind":1,"languageId":"markdown","value":"```javascript\n// 2. Integration Tests: useFacilities Hook\n// Covers: API Mocking, Error States, Facility Selection Scenarios\n/*\n  This test suite validates:\n  - Successful API data fetching and normalization\n  - Fallback behavior on API errors\n  - State management for selection/deselection\n*/\n\nglobal.fetch = jest.fn();\n\ndescribe('useFacilities Hook', () => {\n    afterEach(() => { jest.clearAllMocks(); });\n\n    // Scenario: API Data Fetching (Success)\n    test('API Mocking: Fetches and normalizes data', async () => {\n        const mockData = { objs: [{ id: '1', name: 'Fac1', location: { city: 'City', state: 'ST' } }] };\n        fetch.mockResolvedValueOnce({ ok: true, json: async () => mockData });\n\n        const { result, waitForNextUpdate } = renderHook(() => useFacilities());\n        \n        expect(result.current.loading).toBe(true);\n        await waitForNextUpdate();\n        \n        expect(result.current.facilities[0]).toEqual(expect.objectContaining({\n            id: '1',\n            name: 'Fac1',\n            city: 'City'\n        }));\n        expect(result.current.loading).toBe(false);\n    });\n\n    // Scenario: Error State Handling\n    test('Error State: Handles API failure gracefully', async () => {\n        fetch.mockRejectedValueOnce(new Error('Network Error'));\n\n        const { result, waitForNextUpdate } = renderHook(() => useFacilities());\n        await waitForNextUpdate();\n\n        expect(result.current.error).toBe('Fetch failed');\n        // Verify fallback data is loaded\n        expect(result.current.facilities.length).toBeGreaterThan(0);\n        expect(result.current.facilities[0].id).toBe('fac-001');\n    });\n\n    // Scenario: Selection Logic\n    test('Facility Selection Scenarios', async () => {\n        fetch.mockResolvedValueOnce({ ok: true, json: async () => [] });\n        const { result, waitForNextUpdate } = renderHook(() => useFacilities());\n        await waitForNextUpdate();\n\n        // Test Selection\n        act(() => { result.current.selectFacility('fac-A'); });\n        expect(result.current.selectedFacilities).toContain('fac-A');\n\n        // Test Multi-Selection\n        act(() => { result.current.selectFacility('fac-B'); });\n        expect(result.current.selectedFacilities).toEqual(['fac-A', 'fac-B']);\n\n        // Test Deselection\n        act(() => { result.current.deselectFacility('fac-A'); });\n        expect(result.current.selectedFacilities).toEqual(['fac-B']);\n        \n        // Test Clear\n        act(() => { result.current.clearSelection(); });\n        expect(result.current.selectedFacilities).toEqual([]);\n    });\n});\n```","output":[],"executionSummary":{}},{"kind":1,"languageId":"markdown","value":"## 3. Utility Logic Tests (Runnable)\n\nThese tests validate pure JavaScript utility functions used in the UI.\nSince they do not rely on React or the DOM, they can be executed directly in this notebook environment.","output":[],"executionSummary":{}},{"kind":2,"languageId":"javascript","value":"// Function Definitions (Copied from weatherWidget.js for isolated testing)\nconst toC = (f) => Math.round((f - 32) * 5 / 9);\nconst formatTemp = (t, u) => (typeof t === 'number' ? (u === 'F' ? t : toC(t)) : null);\nconst formatLabel = (f) => {\n    const s = [f.city, f.state].filter(Boolean).join(', ');\n    return s ? `${f.name} (${s})` : f.name;\n};\nconst formatTz = (s) => {\n    if (typeof s !== 'number') return 'Unknown Timezone';\n    const h = s / 3600;\n    const map = { '-5': 'Eastern', '-6': 'Central', '-7': 'Mountain', '-8': 'Pacific', '-9': 'Alaska', '-10': 'Hawaii' };\n    return `${map[h] || 'Pacific'} Time Zone (UTC${h < 0 ? '-' : '+'}${Math.abs(h).toString().padStart(2, '0')}:00)`;\n};\n\n// Simple Test Runner\nconst runTest = (name, testFn) => {\n    try {\n        testFn();\n        return `✅ PASS: ${name}`;\n    } catch (e) {\n        return `❌ FAIL: ${name} - ${e.message}`;\n    }\n};\n\nconst assert = (actual, expected, msg) => {\n    if (actual !== expected) throw new Error(`${msg} (Expected: ${expected}, Got: ${actual})`);\n};\n\n// Execution\n[\n    runTest('Temperature: F to C', () => {\n        assert(formatTemp(32, 'C'), 0, '32F -> 0C');\n        assert(formatTemp(212, 'C'), 100, '212F -> 100C');\n    }),\n    runTest('Temperature: F to F', () => {\n        assert(formatTemp(72, 'F'), 72, '72F -> 72F');\n    }),\n    runTest('Label Formatting', () => {\n        assert(formatLabel({name: 'Fac', city: 'City', state: 'ST'}), 'Fac (City, ST)', 'Full Location');\n        assert(formatLabel({name: 'FacOnly'}), 'FacOnly', 'Name Only');\n    }),\n    runTest('Timezone Formatting', () => {\n        // -28800 seconds = -8 hours\n        assert(formatTz(-28800), 'Pacific Time Zone (UTC-08:00)', 'Pacific Offset');\n    })\n].join('\\n')","output":[{"items":[{"mime":"text/plain","value":["✅ PASS: Temperature: F to C","✅ PASS: Temperature: F to F","✅ PASS: Label Formatting","✅ PASS: Timezone Formatting"]}]}],"executionSummary":{"timing":{"startTime":1769126120038,"endTime":1769126137578},"executionOrder":1,"success":true}},{"kind":2,"languageId":"javascript","value":"// -- Data Normalization Tests (Runnable) --\n// Extracted from useFacilities.ts\n\nconst normalize = (f) => {\n    const l = f.location || f.coordinates || {};\n    return {\n        id: f.id || f.facilityId,\n        name: f.name || f.facilityName || f.label,\n        city: f.city || l.city || f.locationName || f.cityName || '',\n        state: f.state || l.state || f.stateCode || f.region || '',\n        latitude: Number(f.latitude ?? f.geometry?.latitude ?? l.latitude ?? l.lat ?? 0),\n        longitude: Number(f.longitude ?? f.geometry?.longitude ?? l.longitude ?? l.lon ?? 0),\n        type: f.type || f.facilityType\n    };\n};\n\n// Re-using Test Runner\nconst assertStr = (actual, expected, msg) => {\n    if (actual !== expected) throw new Error(`${msg} (Expected: \"${expected}\", Got: \"${actual}\")`);\n};\nconst assertNum = (actual, expected, msg) => {\n    if (actual !== expected) throw new Error(`${msg} (Expected: ${expected}, Got: ${actual})`);\n};\n\n// Test Scenarios\n[\n    runTest('Normalization: Standard Format', () => {\n        const input = { id: '1', name: 'F1', city: 'C1', state: 'S1', latitude: 10, longitude: 20 };\n        const res = normalize(input);\n        assertStr(res.name, 'F1', 'Name match');\n        assertNum(res.latitude, 10, 'Lat match');\n    }),\n\n    runTest('Normalization: Nested Location', () => {\n        const input = { facilityId: '2', facilityName: 'F2', location: { city: 'C2', state: 'S2', lat: 30, lon: 40 } };\n        const res = normalize(input);\n        assertStr(res.name, 'F2', 'Alt name match');\n        assertStr(res.city, 'C2', 'Nested city match');\n        assertNum(res.latitude, 30, 'Nested lat match');\n    }),\n\n    runTest('Normalization: Geometry Format', () => {\n        const input = { label: 'F3', geometry: { latitude: 50, longitude: 60 } };\n        const res = normalize(input);\n        assertStr(res.name, 'F3', 'Label match');\n        assertNum(res.longitude, 60, 'Geometry lon match');\n    }),\n\n    runTest('Normalization: Fallbacks', () => {\n        const input = {};\n        const res = normalize(input);\n        assertStr(res.city, '', 'Empty city fallback');\n        assertNum(res.latitude, 0, 'Zero lat fallback');\n    })\n].join('\\n')","output":[{"items":[{"mime":"text/plain","value":["✅ PASS: Normalization: Standard Format","✅ PASS: Normalization: Nested Location","✅ PASS: Normalization: Geometry Format","✅ PASS: Normalization: Fallbacks"]}]}],"executionSummary":{"timing":{"startTime":1769126141504,"endTime":1769126141659},"executionOrder":2,"success":true}},{"kind":2,"languageId":"javascript","value":"// -- Custom Location Validation Tests (Runnable) --\n// Extracted from CustomLocationModal.js form logic\n\nconst validateForm = (name, lat, lon) => {\n    let errors = [];\n    if (!name || name.length < 3) errors.push('Name must be 3+ chars');\n    \n    // Simple coordinate range validation\n    const nLat = parseFloat(lat);\n    const nLon = parseFloat(lon);\n    \n    if (isNaN(nLat) || nLat < -90 || nLat > 90) errors.push('Invalid Latitude (-90 to 90)');\n    if (isNaN(nLon) || nLon < -180 || nLon > 180) errors.push('Invalid Longitude (-180 to 180)');\n    \n    return errors;\n};\n\n// Test Scenarios\n[\n    runTest('Validator: Valid Input', () => {\n        const errs = validateForm('New Site', '45.0', '-100.5');\n        assertNum(errs.length, 0, 'No errors for valid input');\n    }),\n    \n    runTest('Validator: Short Name', () => {\n        const errs = validateForm('A', '0', '0');\n        assert(errs.includes('Name must be 3+ chars'), true, 'Catch short name');\n    }),\n    \n    runTest('Validator: Invalid Coordinates', () => {\n        const errs = validateForm('Base', '100', '-200'); // 100 > 90, -200 < -180\n        assert(errs.includes('Invalid Latitude (-90 to 90)'), true, 'Catch Lat error');\n        assert(errs.includes('Invalid Longitude (-180 to 180)'), true, 'Catch Lon error');\n    }),\n    \n    runTest('Validator: Non-Numeric', () => {\n        const errs = validateForm('Base', 'fast', 'slow');\n        assertNum(errs.length, 2, 'Catch non-number inputs');\n    })\n].join('\\n')","output":[{"items":[{"mime":"text/plain","value":["✅ PASS: Validator: Valid Input","✅ PASS: Validator: Short Name","✅ PASS: Validator: Invalid Coordinates","✅ PASS: Validator: Non-Numeric"]}]}],"executionSummary":{"timing":{"startTime":1769126145080,"endTime":1769126145216},"executionOrder":3,"success":true}},{"kind":2,"languageId":"javascript","value":"// -- Mock Facility Data Tests (Runnable) --\n// Verifies that fallback data used during API failures is valid\n// Source: useFacilities.ts\n\nconst FALLBACK_FACILITIES_MOCK = [\n    { id: 'fac-001', name: 'Main Facility', city: 'New York', state: 'NY', latitude: 40.7128, longitude: -74.006, type: 'headquarters' },\n    { id: 'fac-002', name: 'West Coast Hub', city: 'Los Angeles', state: 'CA', latitude: 34.0522, longitude: -118.2437, type: 'regional' },\n    { id: 'fac-003', name: 'Central Office', city: 'Chicago', state: 'IL', latitude: 41.8781, longitude: -87.6298, type: 'regional' }\n];\n\n[\n    runTest('Mock Data: Structure Validation', () => {\n        FALLBACK_FACILITIES_MOCK.forEach(f => {\n            if (!f.id.startsWith('fac-')) throw new Error(`Invalid Mock ID: ${f.id}`);\n            if (typeof f.latitude !== 'number' || typeof f.longitude !== 'number') throw new Error('Invalid Mock Coordinates');\n        });\n    }),\n\n    runTest('Mock Data: Normalization Compliance', () => {\n        // Relies on 'normalize' from the Data Normalization cell\n        if (typeof normalize !== 'function') throw new Error('normalize function not found - run Normalization cell first');\n        \n        const result = FALLBACK_FACILITIES_MOCK.map(normalize);\n        assertNum(result.length, 3, 'Should produce 3 normalized records');\n        assertStr(result[0].id, 'fac-001', 'ID preservation');\n        assertStr(result[1].city, 'Los Angeles', 'City preservation');\n    })\n].join('\\n')","output":[{"items":[{"mime":"text/plain","value":["\u001b[31m---------------------------------------------------------------------------\u001b[0m","Error: Failed to connect to application: app9rel with:","Error: Connection failed. Status code: 400, Reason: 400, Response: "]}]}],"executionSummary":{"timing":{"startTime":1769463880225,"endTime":1769463880871},"executionOrder":2,"success":false}},{"kind":2,"languageId":"javascript","value":"// -- Configuration Service Tests (Runnable) --\n// Verifies admin configuration loading logic\n// Source: services/configService.js\n\nconst DEFAULT_CONFIG_MOCK = {\n    refreshIntervalMinutes: 60,\n    features: { enableThemeToggle: false }\n};\n\nconst MockConfigService = {\n    getConfig: async () => {\n        return new Promise(resolve => resolve(DEFAULT_CONFIG_MOCK));\n    }\n};\n\n[\n    runTest('Config: Load Defaults', async () => {\n        const cfg = await MockConfigService.getConfig();\n        assertNum(cfg.refreshIntervalMinutes, 60, 'Default refresh config');\n    }),\n    \n    runTest('Config: Feature Flags', async () => {\n        const cfg = await MockConfigService.getConfig();\n        assert(cfg.features.enableThemeToggle, false, 'Theme toggle default');\n    })\n].join('\\n')","output":[{"items":[{"mime":"text/plain","value":["✅ PASS: Config: Load Defaults","✅ PASS: Config: Feature Flags"]}]}],"executionSummary":{"timing":{"startTime":1769126151209,"endTime":1769126151370},"executionOrder":5,"success":true}},{"kind":2,"languageId":"javascript","value":"21.0.1-alpha.6+6.8.9.0-rc.629.437b84048ea2dcad7c26b5f2b03dd2561dbb9ba6.task.rel21-8.9.uid.02480067","output":[{"items":[{"mime":"text/plain","value":["\u001b[31m---------------------------------------------------------------------------\u001b[0m","Error: Failed to connect to application: app9rel with:","Error: Connection failed. Status code: 400, Reason: 400, Response: "]}]}],"executionSummary":{"timing":{"startTime":1769463599056,"endTime":1769463600325},"executionOrder":1,"success":false}}],"metadata":{"id":"ada50f9d-4e46-446b-b374-d1665b436cc8","appName":"app9rel","serializerVersion":"1","runtime":"js-rhino"}}